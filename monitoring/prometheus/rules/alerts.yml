# Alert Rules for Crypto Quant System
# ====================================

groups:
  # ===========================================================================
  # Trading Alerts
  # ===========================================================================
  - name: trading_alerts
    rules:
      # Large position alert
      - alert: LargePositionOpened
        expr: trading_position_size_krw > 10000000
        for: 1m
        labels:
          severity: warning
          category: trading
        annotations:
          summary: "Large position opened"
          description: "Position size {{ $value | humanize }} KRW exceeds threshold"

      # High loss alert
      - alert: HighUnrealizedLoss
        expr: trading_unrealized_pnl_krw < -500000
        for: 5m
        labels:
          severity: critical
          category: trading
        annotations:
          summary: "High unrealized loss detected"
          description: "Unrealized P&L is {{ $value | humanize }} KRW"

      # Trading bot offline
      - alert: TradingBotDown
        expr: up{job="trading-bot"} == 0
        for: 2m
        labels:
          severity: critical
          category: trading
        annotations:
          summary: "Trading bot is down"
          description: "Trading bot has been unreachable for more than 2 minutes"

      # No trades in expected time window
      - alert: NoTradingActivity
        expr: increase(trading_orders_total[1h]) == 0 and trading_bot_active == 1
        for: 2h
        labels:
          severity: warning
          category: trading
        annotations:
          summary: "No trading activity"
          description: "No orders placed in the last 2 hours while bot is active"

  # ===========================================================================
  # ML Pipeline Alerts
  # ===========================================================================
  - name: ml_alerts
    rules:
      # Model prediction latency
      - alert: HighPredictionLatency
        expr: histogram_quantile(0.95, rate(ml_prediction_duration_seconds_bucket[5m])) > 1
        for: 5m
        labels:
          severity: warning
          category: ml
        annotations:
          summary: "High model prediction latency"
          description: "95th percentile prediction latency is {{ $value }}s"

      # Model accuracy degradation
      - alert: ModelAccuracyDrop
        expr: ml_model_accuracy < 0.6
        for: 15m
        labels:
          severity: critical
          category: ml
        annotations:
          summary: "Model accuracy dropped"
          description: "Model accuracy is {{ $value | humanizePercentage }}"

      # Data drift detected
      - alert: DataDriftDetected
        expr: ml_data_drift_score > 0.3
        for: 10m
        labels:
          severity: warning
          category: ml
        annotations:
          summary: "Data drift detected"
          description: "Drift score {{ $value }} exceeds threshold"

      # Feature staleness
      - alert: StaleFeatures
        expr: (time() - feast_feature_freshness_seconds) > 3600
        for: 5m
        labels:
          severity: warning
          category: ml
        annotations:
          summary: "Feature data is stale"
          description: "Features haven't been updated in {{ $value | humanizeDuration }}"

  # ===========================================================================
  # Data Pipeline Alerts
  # ===========================================================================
  - name: pipeline_alerts
    rules:
      # Airflow DAG failure
      - alert: AirflowDagFailed
        expr: airflow_dag_run_state{state="failed"} > 0
        for: 1m
        labels:
          severity: critical
          category: pipeline
        annotations:
          summary: "Airflow DAG failed"
          description: "DAG {{ $labels.dag_id }} has failed"

      # Airflow task SLA miss
      - alert: AirflowSlaMiss
        expr: increase(airflow_sla_miss_total[1h]) > 0
        for: 1m
        labels:
          severity: warning
          category: pipeline
        annotations:
          summary: "Airflow SLA missed"
          description: "SLA has been missed for a task"

      # DuckDB query performance
      - alert: SlowDuckDBQueries
        expr: histogram_quantile(0.95, rate(duckdb_query_duration_seconds_bucket[5m])) > 30
        for: 10m
        labels:
          severity: warning
          category: pipeline
        annotations:
          summary: "Slow DuckDB queries"
          description: "95th percentile query time is {{ $value }}s"

      # Data freshness
      - alert: StaleOHLCVData
        expr: (time() - data_last_ohlcv_timestamp) > 86400
        for: 5m
        labels:
          severity: warning
          category: pipeline
        annotations:
          summary: "OHLCV data is stale"
          description: "Last OHLCV update was {{ $value | humanizeDuration }} ago"

  # ===========================================================================
  # System Alerts
  # ===========================================================================
  - name: system_alerts
    rules:
      # High CPU usage
      - alert: HighCPUUsage
        expr: 100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 85
        for: 10m
        labels:
          severity: warning
          category: system
        annotations:
          summary: "High CPU usage"
          description: "CPU usage is {{ $value }}%"

      # High memory usage
      - alert: HighMemoryUsage
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 90
        for: 5m
        labels:
          severity: critical
          category: system
        annotations:
          summary: "High memory usage"
          description: "Memory usage is {{ $value }}%"

      # Disk space low
      - alert: LowDiskSpace
        expr: (1 - (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"})) * 100 > 85
        for: 10m
        labels:
          severity: warning
          category: system
        annotations:
          summary: "Low disk space"
          description: "Disk usage is {{ $value }}%"

      # Service down
      - alert: ServiceDown
        expr: up == 0
        for: 2m
        labels:
          severity: critical
          category: system
        annotations:
          summary: "Service is down"
          description: "{{ $labels.job }} service is unreachable"
